## 网络栈和资源加载
此内容为笔者学习和自我总结，有错误的地方请谅解和指出，笔者定会及时更正。学习的路上，一起互助前行。   

这里，我们讲一下chrome中有关资源的加载。从用户输入url到chrome浏览器加载资源的过程，以及怎么资源进行高效的管理。

1. 先介绍下资源加载的基础设施    
    1）HTML资源支持的类型。包括：   
        a. HTML：HTML页面，包括各种各样的HTML元素。  
        b. JS：js代码。可以是内嵌的，也可以是单独的文件。  
        c. CSS样式表：css样式资源。可以是内嵌的，也可以是单独的文件。  
        d. 图片。  
        e. 字体文件。   
        f. 等...

    > 资源加载器：分类以及大概作用。   
        1) 针对每种资源类型的特定加载器。其特点是仅加载某一种资源。ImageLoader类仅加载图片资源。  
        2）资源缓存机制的资源加载器。特点是所有加载器都需要通过它来检查和插入缓存资源。  
        3）通用资源加载器--ResourceLoader类。当webkit需要从网络或者文件系统获取资源时负责获取资源的数据。  
        webkit以这样的方式设计加载器，目的是想将加载的复杂机制逐渐简化为若干简单步骤。  


    这些资源在webkit中都有不同的类表示，这些类的公共基类是CachedResource。比如：CachedScript存储js资源，CachedCssStyleSheet类存储样式表，等。  
    那为什么基类是'Cached'字样呢？这里是因为资源加载的效率问题引入了缓存机制，它对资源的请求都会先获取缓存中的信息，以决定是否向服务器请求资源。  

    那什么是资源的缓存呢？  

    2）资源缓存  
        这里主要说的缓存位置：内存缓存（memory cache）,磁盘缓存（disk cache）；当然还有service worker 缓存，以及http2协议涉及的Push Cache。    
        a. 内存资源的缓存机制的基本思路：  
            建立一个资源的缓存池，当webkit请求资源时，先从资源池中查看有没有响应资源。有则取出使用。如果没有，webkit会先创建一个新的CachedResource子类的对象，等待webkit收到资源后，以url为资源的唯一标识符，将其资源设置到新的CachedResource子类的对象中，待下次使用。   
            内存缓存固然快，不过内存存在时间较短，当相应进程释放，内存缓存也会被清除。

        b. 磁盘本地缓存   
            为了进一步提升资源的加载效率（当进程释放后，再进入时，资源其实没有改变的），提出磁盘缓存机制。把资源存储在本地磁盘中。   

            1）磁盘存储的结构   
                数据以表的形式存储在磁盘上。分索引文件，和数据文件（块文件）。
                1.1) 索引文件： 
                    用来方便快速检索存放在数据文件中的索引项。包括索引头，和索引地址。索引文件直接将文件映射到内存地址（个人感觉应该是逻辑地址），方便快速找到表项的索引地址。  
                    头部包括：索引版本号，索引项数目，文件大小等。  
                    索引地址：保存各个表项对应的索引地址。  
                    
                1.2）数据文件（块文件）  
                    由很多特定大小的块组成，数据块的内容是表项。表项结构可以大致分为两部分：  
                    a. 用于数据标记的内容。包括元数据信息，自身内容,通常比较少变动。   
                    b. 包括回收算法服务所需信息，具体存储数据信息（也很可能是指向具体信息存放的地址）。更多详情，可参照如下： 
    [Disk Cache](http://www.chromium.org/developers/design-documents/network-stack/disk-cache)  
    > Disk Cache:http://www.chromium.org/developers/design-documents/network-stack/disk-cache

            想比于内存缓存，磁盘能存的多，时间也可以更长，但磁盘的读取效率低。  
            
    >   不过chrome中，具体怎么权衡数据什么时候该缓存在内存中，什么时候该缓存在磁盘中，或者说什么资源应该缓存在内存或磁盘中？   
            笔者比较认可的说法是：(根据内存和磁盘功能来分)  
            1. 大文件，通常优先存磁盘。
            2. 进程未释放，内存空间足够，该进程加载的资源需要缓存的话，优先内存缓存。 
            3. 内存紧张时，优先磁盘缓存。进程要释放时，内存中的资源可以有选择的存入磁盘。  
    
    > 当代浏览器一般的查找缓存顺序：（查询还要带上浏览器缓存策略的条件）
    1. service worker 缓存
    2. memory cache
    3. dist cache
    4. push cache (http2)
    都没命中，再会请求网络。（比如协商缓存）


2. 资源加载的过程。  

todo




